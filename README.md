## Introduction

QuickBuild supports external authentication mainly through [Active Directory and LDAP](https://wiki.pmease.com/display/qb90/Authenticate+with+Active+Directory+and+LDAP); Jira and TeamForge are available as options, yet there isn't any documentation for either.

[OpenID Connect](https://openid.net/connect/) (OIDC) authentication becomes possible when QuickBuild runs behind a [Reverse Proxy](https://wiki.pmease.com/display/qb90/Running+Behind+Apache) that operates as a [Relying Party](https://github.com/zmartzone/mod_auth_openidc) protecting some part of the backend content. The need to keep [anonymous access](https://wiki.pmease.com/display/qb90/Enable+Anonymous+Access+and+Self+Registering) and [internal authentication](https://wiki.pmease.com/display/qb90/Authenticate+with+Active+Directory+and+LDAP) possible places heavy restrictions on what can actually be protected.

This implementation sacrifices the [Self-Registering](https://wiki.pmease.com/display/qb90/Enable+Anonymous+Access+and+Self+Registering) functionality to repurpose it as a protected authentication/callback URL, and to gain its UI links. Related requests are diverted to the chosen OIDC provider, and corresponding callbacks return with an authentication header that determines the user's `Login Name` for [Single Sign-On](https://wiki.pmease.com/display/qb90/Single+sign-on+Support).

The reverse proxy needs to ensure that all requests coming to it are stripped of authentication headers. The authentication/callback URL (repurposed from registration) is already protected from tampering, but possible authentication headers need to be removed from all unprotected URLs as well.

QuickBuild has to trust the authentication header from some specified IP address. Surprisingly, `localhost` cannot be trusted because of its potential for [privilege escalation](https://en.wikipedia.org/wiki/Privilege_escalation): already authenticated users can find out who the administrators are and thereby know their `Login Name`s - and they don't even need `RESTful API Accessible`, `Script Allowed` or inherently dangerous permissions like `EDIT_SETTINGS`, `CREATE_SCRIPT` and `RUN_BUILD`, to authorize their RESTful API calls from shell commands executed locally as the QuickBuild process user, via QuickBuild scripts that any user can insert even without any permissions.

Containerizing the reverse proxy gives it a distinct IP that can be trusted, and even a possible [binding address](https://wiki.pmease.com/display/qb90/Listen+to+specified+IP+address) for QuickBuild; that would force all requests, including RESTful API calls from the `server` build node, to pass through the proxy. This wouldn't give any additional security, since localhost authentication headers are already not trusted.

[My Setting](https://wiki.pmease.com/display/qb90/Manage+User+Profile) normally allows users to change their `Login Name`. This causes problems for any external authenticator. Using [Single Sign-On](https://wiki.pmease.com/display/qb90/Single+sign-on+Support) has forced the reverse proxy to disable it as a security risk: it could have been used to secretly initialize the accounts of still unregistered colleagues with preset passwords. If someone's `Login Name` still needs to be changed, administrators can do that from [User Management](https://wiki.pmease.com/display/qb90/User+and+Group+Management).

<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" preserveAspectRatio="xMidYMid meet" viewBox="0 0 640 640" width="640" height="640"><defs><path d="M157 56.6C157 67.64 148.04 76.6 137 76.6C125.96 76.6 117 67.64 117 56.6C117 45.57 125.96 36.6 137 36.6C148.04 36.6 157 45.57 157 56.6Z" id="airrUwAUX"></path><path d="M109 51.34L100 55.85L100 46.83L100 37.81L109 42.32L118 46.83L109 51.34Z" id="c4y0sWhubi"></path><path d="M109 70.13L100 74.64L100 65.62L100 56.6L109 61.11L118 65.62L109 70.13Z" id="gvvfFPqLV"></path><path d="M32 62.11L23 66.62L23 57.6L23 48.59L32 53.1L41 57.6L32 62.11Z" id="j1DmFBjt3d"></path><path d="M1.12 57.6L23 57.6" id="b3ynahCOJK"></path><path d="M79.29 46.83L100 46.83" id="b5WLFYE6e"></path><path d="M80.19 65.62L100 65.62" id="b4bCGYYv2"></path><path d="M167 61.11L176 65.62L176 56.6L176 47.59L167 52.1L158 56.6L167 61.11Z" id="g1o9bmgrCj"></path><path d="M153.19 44.5L161.52 39.83L169.86 36.6L176 35.5L181.52 36.6L186.19 39.83L188.52 45.5L187.52 51.17L184.19 55.17L180.19 56.6L177.19 56.6" id="ax0IPPqaO"></path><path d="M39.29 33.6L85.29 33.6L85.29 79.6L39.29 79.6L39.29 33.6Z" id="frYrjp9Ut"></path><path d="M82.29 56.6C82.29 67.64 73.33 76.6 62.29 76.6C51.25 76.6 42.29 67.64 42.29 56.6C42.29 45.57 51.25 36.6 62.29 36.6C73.33 36.6 82.29 45.57 82.29 56.6Z" id="bAEK62CoW"></path><path d="M125.85 73.27L121.02 78.42L116.32 81.4L109.92 83.67L101.17 84.67L44.17 84.67L34.67 83.67L27.67 81.92L22.42 79.6L18.17 76.6L15.5 72.45L14.42 68.62L14.42 64.87L15.5 61.65L17.17 59.1L19.67 57.6L22.42 57.6" id="hPfcF0A1J"></path></defs><g><g><g><use xlink:href="#airrUwAUX" opacity="1" fill="#ffffff" fill-opacity="1"></use><g><use xlink:href="#airrUwAUX" opacity="1" fill-opacity="0" stroke="#000000" stroke-width="2" stroke-opacity="1"></use></g></g><g><use xlink:href="#c4y0sWhubi" opacity="1" fill="#ffffff" fill-opacity="1"></use><g><use xlink:href="#c4y0sWhubi" opacity="1" fill-opacity="0" stroke="#000000" stroke-width="2" stroke-opacity="1"></use></g></g><g><use xlink:href="#gvvfFPqLV" opacity="1" fill="#000000" fill-opacity="1"></use><g><use xlink:href="#gvvfFPqLV" opacity="1" fill-opacity="0" stroke="#000000" stroke-width="2" stroke-opacity="1"></use></g></g><g><use xlink:href="#j1DmFBjt3d" opacity="1" fill="#ffffff" fill-opacity="1"></use><g><use xlink:href="#j1DmFBjt3d" opacity="1" fill-opacity="0" stroke="#000000" stroke-width="2" stroke-opacity="1"></use></g></g><g><g><use xlink:href="#b3ynahCOJK" opacity="1" fill-opacity="0" stroke="#000000" stroke-width="2" stroke-opacity="1"></use></g></g><g><g><use xlink:href="#b5WLFYE6e" opacity="1" fill-opacity="0" stroke="#000000" stroke-width="2" stroke-opacity="1"></use></g></g><g><g><use xlink:href="#b4bCGYYv2" opacity="1" fill-opacity="0" stroke="#000000" stroke-width="2" stroke-opacity="1"></use></g></g><g><use xlink:href="#g1o9bmgrCj" opacity="1" fill="#000000" fill-opacity="1"></use><g><use xlink:href="#g1o9bmgrCj" opacity="1" fill-opacity="0" stroke="#000000" stroke-width="2" stroke-opacity="1"></use></g></g><g><g><use xlink:href="#ax0IPPqaO" opacity="1" fill-opacity="0" stroke="#000000" stroke-width="2" stroke-opacity="1"></use></g></g><g><use xlink:href="#frYrjp9Ut" opacity="1" fill="#ffffff" fill-opacity="1"></use><g><use xlink:href="#frYrjp9Ut" opacity="1" fill-opacity="0" stroke="#000000" stroke-width="2" stroke-opacity="1"></use></g></g><g><use xlink:href="#bAEK62CoW" opacity="1" fill="#ffffff" fill-opacity="1"></use><g><use xlink:href="#bAEK62CoW" opacity="1" fill-opacity="0" stroke="#000000" stroke-width="2" stroke-opacity="1"></use></g></g><g><g><use xlink:href="#hPfcF0A1J" opacity="1" fill-opacity="0" stroke="#000000" stroke-width="2" stroke-opacity="1"></use></g></g></g></g></svg>
