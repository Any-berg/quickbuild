<VirtualHost *:80>

   IncludeOptional domain-specific.conf

   #DocumentRoot "/var/www/html"
   #ServerName build.example.com

   ProxyRequests Off

   # turn off and rely on ProxyPassReverse to translate response header URLs
   ProxyPreserveHost Off

   ProxyPassMatch ^/register$ !
   ProxyPass / http://localhost:8810/
   ProxyPassReverse / http://localhost:8810/

   #ProxyErrorOverride On
   #ErrorDocument 503 /retry.php

   # hijack existing but nonessential URL as an alias of SSO (to use its links)
   Alias "/register" "/var/www/html/register.php"

   <LocationMatch ^/$>
      RewriteEngine On
      # if payload contains an email address, extract it into ENV:email
      #RewriteCond %{QUERY_STRING} email=(.+)(%40|@)([^&]+) [NC]
      RewriteCond %{HTTP_COOKIE} email=(.+)(%40|@)([^;]+) [NC]
      RewriteRule (.+) - [NE,E=email:%1@%3]
      # if ENV:email exists but is not accepted, redirect to Forbidden
      RewriteCond %{ENV:email} ${unacceptableEmail}
      RewriteRule .+ - [F]
      # else if ENV:email exists and is accepted, use it in QuickBuild header
      RequestHeader set X-Forwarded-User "%{email}e" env=email
      # remove possible query string
      #RewriteRule (.*) $1? [L]
   </LocationMatch>

   <Location "/signout">
      # unless JSESSIONID_8810 is cleared, SSO seems unable to log in again
      Header add Set-Cookie JSESSIONID_8810=
      # if PHPSESSID is cleared, user MUST reauthenticate after signing out
      #Header add Set-Cookie "PHPSESSID=; Expires=Thu, 01 Jan 1970 00:00:00 GMT"
   </Location>

</VirtualHost>

# https://wiki.pmease.com/display/qb90/Running+Behind+Apache
# https://stackoverflow.com/questions/31476272/how-to-automatically-retry-apache-connection-to-application-server-if-it-returns
